<!doctype html>
<html>
<head>
    <script src="../../../build/output/playcanvas-latest.js"></script>
    <link href="../../style.css" rel="stylesheet" />
</head>

<body>
    <!-- The canvas element -->
    <canvas id="application-canvas"></canvas>

    <script>
        function createMaterial(colors) {
            var material = new pc.scene.PhongMaterial();
            for (var param in colors) {
                material[param] = colors[param];
            }
            material.update();
            return material;
        }

        var canvas = document.getElementById("application-canvas");

        // Create the application and start the update loop
        var application = new pc.fw.Application(canvas);
        application.start();

        // Set the canvas to fill the window and automatically change resolution to be the same as the canvas size
        application.setCanvasFillMode(pc.fw.FillMode.FILL_WINDOW);
        application.setCanvasResolution(pc.fw.ResolutionMode.AUTO);

        // Create an Entity with a camera component
        var cameraEntity = new pc.fw.Entity();
        application.context.systems.camera.addComponent(cameraEntity, {
            clearColor: new pc.Color(0,0,0.05)
        });
        cameraEntity.rotateLocal(0, 0, 0);
        cameraEntity.translateLocal(0, 0, 10);

        // Create a directional light
        var lightDirEntity = new pc.fw.Entity();
        application.context.systems.light.addComponent(lightDirEntity, {
            type: "directional",
            color: new pc.Color(1, 1, 1),
            intensity: 1
        });
        lightDirEntity.setLocalEulerAngles(45,0,0);

        // Add Entities into the scene hierarchy
        application.context.root.addChild(cameraEntity);
        application.context.root.addChild(lightDirEntity);


        // Offset position
        var localPosCurve = new pc.CurveSet([
            [0, 0, 1, 4],
            [0, 0, 1, 3],
            [0, 0, 1, 0]
        ]);
        localPosCurve.type = pc.CURVE_LINEAR;

        // local position divergence
        var localPosDivCurve = new pc.CurveSet([
            [0, 1, 1, 1],
            [0, 1, 1, 1],
            [0, 0, 1, 0]
        ]);

        // world position graph
        var worldPosCurve = new pc.CurveSet([
            [0, 0, 1, 0],
            [0, 0, 0.2, 3, 1, -3],
            [0, 0, 1, 0]
        ]);

        // gradually make sparks bigger
        var scaleCurve = new pc.Curve(
            [0, 0, 0.5, 0.2, 1, 0]
        );

        // rotate sparks
        var angleCurve = new pc.Curve(
            [0, 0, 1, 360]
        );

        // color changes throughout lifetime
        var colorCurve = new pc.CurveSet([
            [0, 1, 0.5, 1, 0.75, 0.5, 1, 0],
            [0, 0, 0.25, 0.25, 0.5, 0.5, 0.75, 0.75, 1, 1],
            [0, 0, 1, 0]
        ]);

        // Create entity for particle system
        var entity = new pc.fw.Entity();
        entity.setLocalPosition(0, 0, 0);

        // load snowflake texture
        application.context.assets.loadFromUrl('../../assets/spark.png', 'texture').then(function (result) {

            // when texture is loaded add particlesystem component to entity
            application.context.systems.particlesystem.addComponent(entity, {
                numParticles: 200,
                lifetime: 2,
                rate: 0.01,
                localOffsetGraph: localPosCurve,
                offsetGraph: worldPosCurve,
                localPosDivGraph: localPosDivCurve,
                scaleGraph: scaleCurve,
                angleGraph: angleCurve,
                colorGraph: colorCurve,
                colorMap: result.resource
            });
        });

    </script>
</body>
</html>
